name: Node.js CI

on:
  push:
    branches: ['**']  # run on pushes to any branch
  pull_request:
    branches: [main]  # run on PRs into main branch
  workflow_dispatch:  # manual "Run workflow" button

jobs:
  install:
    name: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm
      - name: Install dependencies
        run: npm ci

  typescript:
    name: typescript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Create dummy Amplify outputs file
        run: |
          cat > amplify_outputs.json << 'EOF'
          {
            "version": "1",
            "auth": {
              "user_pool_id": "us-east-1_dummy",
              "user_pool_client_id": "dummy_client_id",
              "aws_region": "us-east-1"
            },
            "data": {
              "aws_region": "us-east-1",
              "url": "https://dummy.appsync-api.us-east-1.amazonaws.com/graphql"
            },
            "storage": {
              "aws_region": "us-east-1",
              "bucket_name": "dummy-bucket-name"
            },
            "custom": {
              "API": {
                "bookmarks": {
                  "apiName": "bookmarksApi",
                  "type": "httpApi",
                  "endpoint": "https://dummy.execute-api.us-west-1.amazonaws.com"
                },
                "waitlist": {
                  "apiName": "bookmarksApi",
                  "type": "httpApi",
                  "endpoint": "https://dummy.execute-api.us-west-1.amazonaws.com",
                  "path": "/waitlist"
                }
              }
            }
          }
          EOF
      - name: TypeScript type check (no emit)
        run: npx tsc -p tsconfig.json --noEmit --pretty false

  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Create dummy Amplify outputs file
        run: |
          cat > amplify_outputs.json << 'EOF'
          { "version":"1","auth":{"user_pool_id":"us-east-1_dummy","user_pool_client_id":"dummy_client_id","aws_region":"us-east-1"},"data":{"aws_region":"us-east-1","url":"https://dummy.appsync-api.us-east-1.amazonaws.com/graphql"},"storage":{"aws_region":"us-east-1","bucket_name":"dummy-bucket-name"},"custom":{"API":{"bookmarks":{"apiName":"bookmarksApi","type":"httpApi","endpoint":"https://dummy.execute-api.us-west-1.amazonaws.com"}}}}
          EOF
      - name: Run unit tests
        run: npm test -- --ci

  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Create dummy Amplify outputs file
        run: |
          cat > amplify_outputs.json << 'EOF'
          { "version":"1","auth":{"user_pool_id":"us-east-1_dummy","user_pool_client_id":"dummy_client_id","aws_region":"us-east-1"},"data":{"aws_region":"us-east-1","url":"https://dummy.appsync-api.us-east-1.amazonaws.com/graphql"},"storage":{"aws_region":"us-east-1","bucket_name":"dummy-bucket-name"},"custom":{"API":{"bookmarks":{"apiName":"bookmarksApi","type":"httpApi","endpoint":"https://dummy.execute-api.us-west-1.amazonaws.com"}}}}
          EOF
      - name: Build project
        run: npm run build
